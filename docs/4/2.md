## è„šæœ¬å®ç°

ç¡¬ä»¶ç›´é€šçš„è¯ï¼ŒGithub ä¸Šé¢å·²ç»æœ‰æˆç†Ÿçš„è„šæœ¬äº†ã€‚

é¡¹ç›®åœ°å€ä¸ºï¼š[https://github.com/ivanhao/pvetools](https://github.com/ivanhao/pvetools)

åœ¨é€šå¤–ç½‘çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä¸€é”®å®‰è£…è¿è¡Œï¼Œæ“ä½œååˆ†ç®€å•ï¼Œç»†èŠ‚ä¸å†èµ˜è¿°ï¼š

```bash
echo "nameserver  8.8.8.8" >> /etc/resolv.conf && rm /etc/apt/sources.list.d/pve-enterprise.list && export LC_ALL=en_US.UTF-8 && apt update && apt -y install git && git clone https://github.com/ivanhao/pvetools.git && cd pvetools && ./pvetools.sh
```

## æ‰‹å·¥å®ç°

ä½†æ˜¯ï¼Œæ—¢ç„¶å†™æ•™ç¨‹äº†ï¼Œè‚¯å®šè¿˜æ˜¯è¦è¯´ä¸€ä¸‹å¦‚ä½•æ‰‹å·¥é…ç½®ç¡¬ä»¶ç›´é€šã€‚

### æ£€æµ‹ IOMMU æ˜¯å¦å¼€å¯

å¼€å¯ IOMMU åï¼ŒBIOS å¯ä»¥æ”¶é›† IOMMU ç¡¬ä»¶ç›¸å…³çš„ä¿¡æ¯ä»¥åŠå®ƒå’Œ PCIe è®¾å¤‡è¿æ¥å…³ç³»çš„ä¿¡æ¯ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ£€æµ‹æ˜¯å¦å¼€å¯ï¼Œå¦‚æœå¼€å¯ IOMMU çš„è¯å¯ä»¥çœ‹åˆ°ä¸€äº› PCIe ç¡¬ä»¶è®¾å¤‡ï¼š

```bash
dmesg | grep -e DMAR -e IOMMU
```

=== "æœªå¼€å¯ IOMMU"

	![](https://image.3001.net/images/20221128/16695653049561.png)

=== "å¼€å¯ IOMMU"

	![](https://image.3001.net/images/20221128/16695656836933.png) 

### å¼€å¯ IOMMU å’Œ SR-IOV

> IOMMU æ˜¯ Intel VT-d å’Œ AMD-Vi çš„é€šç”¨åç§°ã€‚

å…ˆå¤‡ä»½ä¸€ä¸‹ grub æ–‡ä»¶ï¼š

```bash
cp /etc/default/grub /etc/default/grub.bak
```

ç„¶åä¿®æ”¹ `/etc/default/grub` æ–‡ä»¶ï¼š

```bash
nano /etc/default/grub
```

å°†ï¼š`GRUB_CMDLINE_LINUX_DEFAULT="quiet"` ä¸‹é¢æˆ‘ä»¬ä¸»è¦æ ¹æ®è‡ªå·±çš„å¹³å°æ¥ä¿®æ”¹è¿™ä¸€è¡Œé…ç½®ã€‚

??? Info "ç¡¬ä»¶ç›´é€šå¯èƒ½éœ€è¦ç”¨åˆ°çš„ä¸€äº›å¸¸è§å‚æ•°è§£é‡Š......  ç‚¹å‡»å±•å¼€è¡¨æ ¼ ğŸ‘‰"

    | å‚æ•° | è§£é‡Šè¯´æ˜ |
    | ---- | -------- |
    |  quiet    |    é»˜è®¤å‚æ•°ï¼Œè¡¨ç¤ºåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­åªæ˜¾ç¤ºé‡è¦ä¿¡æ¯|
    | intel_iommu=on | ç”¨ intel_iommu é©±åŠ¨æ¥é©±åŠ¨ IOMMU ç¡¬ä»¶å•å…ƒ|
    |amd_iommu=on| ç”¨ amd_iommu é©±åŠ¨æ¥é©±åŠ¨ IOMMU ç¡¬ä»¶å•å…ƒ |
    |iommu=pt|åªä¸ºä½¿ç”¨é€ä¼ åŠŸèƒ½çš„è®¾å¤‡å¯ç”¨ IOMMUï¼Œå¹¶å¯ä»¥æä¾›æ›´å¥½çš„åŠŸèƒ½å’Œæ€§èƒ½|
    |pci=assign-busses|éƒ¨åˆ†ç½‘å¡å¼€å¯ SR-IOV éœ€è¦è¿™ä¸ªå‚æ•°ï¼Œå¦åˆ™å¯èƒ½æŠ¥é”™|
    |PCIe_acs_override=downstream|ç”¨äºå°† iommu groups æ‹†åˆ†ï¼Œæ–¹ä¾¿çµæ´»æŒ‰éœ€ç›´é€šä¸€äº›æ¿è½½çš„è®¾å¤‡|
    |PCIe_acs_override=multifunction| PCIe ç›´é€šå¤šåŠŸèƒ½æ”¯æŒï¼Œæé«˜ç›´é€šå®Œç¾åº¦ï¼ˆå¯é€‰ï¼‰|
    |nofb|è¯¥é€‰é¡¹å…è®¸ä½ ä¸ç”¨ä¸€ä¸ªframeç¼“å†²æ¥ä½¿ç”¨å›¾å½¢å®‰è£…ç¨‹åº|
    |textonly|ä»…åœ¨æ–‡æœ¬æ¨¡å¼ä¸‹æ”¯æŒ GRUB ä¸²è¡Œæ§åˆ¶å°|
    |nomodeset|ç³»ç»Ÿå¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œæš‚æ—¶ä¸è¿è¡Œå›¾åƒé©±åŠ¨ç¨‹åº|
    |video=vesafb:off|ç¦ç”¨ vesa å¯åŠ¨æ˜¾ç¤ºè®¾å¤‡|
    |video=efifb:off|ç¦ç”¨ efi å¯åŠ¨æ˜¾ç¤ºè®¾å¤‡|
    |video=simplefb:off| 5.15 å†…æ ¸å¼€å§‹ç›´é€šå¯èƒ½éœ€è¦è¿™ä¸ªå‚æ•°|
    |initcall_blacklist=sysfb_init|éƒ¨åˆ† A å¡å¦‚ RX580 ç›´é€šå¼‚å¸¸å¯èƒ½éœ€è¦è¿™ä¸ªå‚æ•°|
    |pcie_aspm=off|å…³é—­ PCIe è®¾å¤‡çš„ ASPM èŠ‚èƒ½æ¨¡å¼ï¼Œè§£å†³éƒ¨åˆ† PCIe è®¾å¤‡ AER æŠ¥é”™|
    |pcie_aspm=force|å¼ºåˆ¶ PCIe è®¾å¤‡åŠçˆ±æƒ… ASPM èŠ‚èƒ½æ¨¡å¼ï¼Œè§£å†³éƒ¨åˆ† PCIe è®¾å¤‡ AER æŠ¥é”™|
    |pci=noaer|ä¸è¾“å‡º AER æŠ¥é”™æ—¥å¿—ï¼Œåå—ä¸»æ¿ç»å¸¸ä¼š AER æŠ¥é”™ï¼Œå»ºè®®é…åˆä½¿ç”¨ï¼Œçœ¼ä¸è§å¿ƒä¸çƒ¦|
    |pci=nomsi|åœ¨ç³»ç»ŸèŒƒå›´å†…ç¦ç”¨ MSI ä¸­æ–­ï¼Œä¸»è¦è¿˜æ˜¯è§£å†³ PCIe ç›¸å…³çš„æŠ¥é”™|
    |pci=nommconf|è§£å†³ PCIe ç›¸å…³çš„æŠ¥é”™ï¼ŒPCIe Bus Error ç­‰ï¼Œåå—ä¸»æ¿å¯èƒ½éœ€è¦è¿™ä¸ªå‚æ•°|


- Intel å¹³å° ä¿®æ”¹ä¸ºï¼š

```ini
GRUB_CMDLINE_LINUX_DEFAULT="quiet intel_iommu=on iommu=pt textonly nomodeset nofb pci=noaer pcie_acs_override=downstream,multifunction"
```

- AMD å¹³å° ä¿®æ”¹ä¸ºï¼š

```ini
GRUB_CMDLINE_LINUX_DEFAULT="quiet amd_iommu=on iommu=pt textonly nomodeset nofb pci=noaer pcie_acs_override=downstream,multifunction"
```

??? Warning "éƒ¨åˆ†æ˜¾å¡å¦‚ RX580 ç›´é€šçš„æ—¶å€™ç¨å¾®ä¸ä¸€æ ·ï¼Œå¾—ä½¿ç”¨ **initcall_blacklist=sysfb_init** æ›¿ä»£ video ç³»åˆ—å‚æ•°"
	```ini
	GRUB_CMDLINE_LINUX_DEFAULT="quiet intel_iommu=on iommu=pt pci=assign-busses pcie_acs_override=downstream,multifunction nofb textonly nomodeset initcall_blacklist=sysfb_init"
	```
	å¦åˆ™å¤§æ¦‚ç‡ä¼šå¡ **Failed to mmap 0000:xxx:00.0 BAR 0. Performance may be slow**


æ”¹å®Œä¹‹åæ›´æ–°ä¸€ä¸‹ grub å¹¶é‡å¯ï¼š

```bash
update-grub && reboot
```

ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹æ˜¯å¦æ‹†åˆ†äº† iommu groupsï¼š

```bash
ls -l /sys/kernel/iommu_groups/*/devices
```

=== "æœªæ‹†åˆ† iommu groups"

	![](https://image.3001.net/images/20221128/16695678959296.png)

=== "å·²æ‹†åˆ† iommu groups"

	![](https://image.3001.net/images/20221128/16695678279862.png) 

### æ·»åŠ  VFIO æ¨¡å—

ä¸ºäº†æˆ‘ä»¬çš„æ˜¾å¡é¡ºåˆ©ç›´é€šï¼Œéœ€è¦æ·»åŠ  VFIO æ¨¡å—åˆ° **/etc/modules** æ–‡ä»¶ä¸­ï¼š

```bash
echo "vfio" > /etc/modules
echo "vfio_iommu_type1s" >> /etc/modules
echo "vfio_pci" >> /etc/modules
echo "vfio_virqfd" >> /etc/modules
```

å°†å¸¸è§çš„é©±åŠ¨ç¨‹åºåŠ å…¥é»‘åå•ï¼Œå³è®© GPU ç›¸å…³è®¾å¤‡åœ¨ä¸‹æ¬¡ç³»ç»Ÿå¯åŠ¨ä¹‹åä¸ä½¿ç”¨è¿™äº›é©±åŠ¨ï¼ŒæŠŠè®¾å¤‡è…¾å‡ºæ¥ç»™ vfio é©±åŠ¨ç”¨ï¼š

```bash
echo "blacklist nvidiafb" >> /etc/modprobe.d/blacklist.conf
echo "blacklist nouveau" >> /etc/modprobe.d/blacklist.conf
echo "blacklist nvidia" >> /etc/modprobe.d/blacklist.conf
echo "blacklist radeon" >> /etc/modprobe.d/blacklist.conf
echo "blacklist amdgpu" >> /etc/modprobe.d/blacklist.conf
echo "blacklist snd_hda_intel" >> /etc/modprobe.d/blacklist.conf
echo "blacklist snd_hda_codec_hdmi" >> /etc/modprobe.d/blacklist.conf
echo "blacklist i915" >> /etc/modprobe.d/blacklist.conf
```

ç„¶åæ›´æ–°å†…æ ¸é‡å¯æœºå™¨ï¼š

```bash
update-initramfs -u && reboot
```

é‡å¯åï¼Œæ£€æŸ¥ä¹‹å‰é…ç½®çš„ VFIO æ¨¡å—æ˜¯å¦æ­£å¸¸åŠ è½½ï¼š

```bash
lsmod |grep vfio
```

ä¸‹å›¾è¿™æ ·è¡¨ç¤ºæ˜¯æˆåŠŸåŠ è½½äº†çš„ã€‚

![](https://image.3001.net/images/20221211/16707611391306.png)   

### IOMMU ä¸­æ–­é‡æ˜ å°„

å¦‚æœæ²¡æœ‰ä¸­æ–­é‡æ–°æ˜ å°„ï¼Œå°†æ— æ³•ä½¿ç”¨ PCI ç›´é€šã€‚æ‰€æœ‰ä½¿ç”¨æ”¯æŒè‹±ç‰¹å°”å®šå‘ I/O è™šæ‹ŸåŒ–æŠ€æœ¯ (VT-d) ä½†ä¸æ”¯æŒä¸­æ–­é‡æ–°æ˜ å°„çš„è‹±ç‰¹å°”å¤„ç†å™¨å’ŒèŠ¯ç‰‡ç»„çš„ç³»ç»Ÿéƒ½æŠ¥é”™ã€‚è¾ƒæ–°çš„å¤„ç†å™¨å’ŒèŠ¯ç‰‡ç»„ï¼ˆAMD å’Œ Intelï¼‰éƒ½æä¾›äº†ä¸­æ–­é‡æ–°æ˜ å°„æ”¯æŒã€‚

å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ¥ç¡®å®šç³»ç»Ÿæ˜¯å¦æ”¯æŒä¸­æ–­é‡æ˜ å°„ï¼š

```bash
dmesg | grep 'remapping'
```

å¦‚æœçœ‹åˆ°ç±»ä¼¼ä¸‹é¢çš„å†…å®¹ä¹‹ä¸€ï¼š

```
"AMD-Vi: Interrupt remapping enabled"
"DMAR-IR: Enabled IRQ remapping in x2apic mode"
```

> x2apic åœ¨ä¸åŒçš„ CPU ä¸Šå¯èƒ½å«æ³•ä¸ä¸€æ ·ï¼Œé—®é¢˜ä¸å¤§ã€‚
>
> å¦å¤–å¦‚æœä½ çš„ CPU ä¸æ”¯æŒ x2apic çš„è¯ï¼Œå¯èƒ½æ˜¯ BIOS æ²¡æœ‰å¼€å¯ï¼Œæˆ‘çš„åå— X99 æ˜¯éœ€è¦æ‰‹åŠ¨åœ¨ BIOS é‡Œé¢å¼€å¯çš„ï¼šåœ¨ ã€InterRCSetupã€‘ - ã€Processor Configurationã€‘ é‡Œé¢å¯ä»¥æ‰“å¼€ **X2APIC** é€‰é¡¹ã€‚

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ IOMMU æ˜¯æ”¯æŒä¸­æ–­æ˜ å°„çš„ï¼š

![](https://image.3001.net/images/20221211/1670761098251.png)  

å¦‚æœå¾ˆä¸å·§ï¼Œä½ çš„ç”µè„‘çœŸçš„ä¸æ”¯æŒ IOMMU ä¸­æ–­é‡æ˜ å°„çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ä¿®è¡¥ä¸€ä¸‹ï¼š

```bash
echo "options vfio_iommu_type1 allow_unsafe_interrupts=1" > /etc/modprobe.d/iommu_unsafe_interrupts.conf
```

### OVMF ä¸‹æ˜¾å¡ç›´é€š

è™šæ‹Ÿæœºçš„ BIOS æ¨èä¸º **OVMF** æ›¿ä»£é»˜è®¤çš„ SeaBIOSã€‚ä¸è¿‡ OVMF èµ°çš„ UEFI åªæ”¯æŒé«˜ç‰ˆæœ¬çš„ Windows ï¼ˆwin >=8ï¼‰,å¦å¤–æœºå‹æ¨èä¸ºï¼š**q35**

é¦–å…ˆæŸ¥æ‰¾æ˜¾å¡ç›¸å…³çš„ IDï¼š

```bash
lspci -nn | grep -E "Display|VGA|Audio|AMD|NVIDIA"
```

![](https://image.3001.net/images/20230112/16734894588141.png)    

é™¤äº†ç¬¬ 1 ä¸ªæ˜¯ä¸»æ¿è‡ªå¸¦çš„å£°å¡ä»¥å¤–ï¼Œä¸‹é¢è¿™ 7 ä¸ª IDå°±æ˜¯æˆ‘æ˜¾å¡ç›¸å…³çš„ ID äº†ï¼ˆå¤šä¸ª ID ä½¿ç”¨é€—å·éš”å¼€ï¼‰ï¼š

```ini
10de:0fc2,10de:0e1b,10de:1bb3,10de:2487,10de:228b,1002:67df,1002:aaf0
```

å°†ä¸Šé¢æŸ¥æ‰¾çš„ ID æ•°æ®å¸¦å…¥åˆ°ä¸‹é¢çš„ **ids** åé¢ï¼Œå¦‚æœä½¿ç”¨ OVMF çš„è¯ï¼Œè¿˜å»ºè®®å°† **disable_vga=1** æ·»åŠ åˆ° vfio-pci æ¨¡å—ï¼š

```bash
echo "options vfio-pci ids=10de:0fc2,10de:0e1b,10de:1bb3,10de:2487,10de:228b,1002:67df,1002:aaf0 disable_vga=1" > /etc/modprobe.d/vfio.conf
```

é‡å¯ä¹‹åå³å¯ç›´æ¥ç›´é€šæ˜¾å¡å’Œå„ç§ PCIe è®¾å¤‡äº†ï¼Œå¦å¤–è¿˜æœ‰æé†’ä¸€ä¸‹ï¼Œ OVMF æ¨¡å¼ä¸‹ç›´é€š GPU çš„è¯ï¼Œæœ‰äº›å¡è¿˜éœ€è¦ romfile å‚æ•°æ¥æŒ‡å®šæ˜¾å¡åŸæœ¬çš„  ROM (bios)æ–‡ä»¶æ‰å¯ä»¥ï¼š

```ini
hostpci0: 01:00,x-vga=on,romfile=vbios.rom
```

???+ info "æå–æ˜¾å¡çš„åŸå§‹ ROM "

    1. é€šç”¨æ–¹æ³•ï¼šWindows ä¸‹ä½¿ç”¨ GPU-Z æ¥ä¿å­˜æ˜¾å¡çš„ ROM æ–‡ä»¶
    2. ä¸‹è½½ç½‘ä¸Šçš„ ROM æ–‡ä»¶, ROM åˆ†äº«ä¸‹è½½ç½‘ç«™ï¼šhttps://www.techpowerup.com/vgabios/

!!! Note "éƒ¨åˆ†æ˜¾å¡ä¸éœ€è¦ romfile å‚æ•°ä¹Ÿå¯ä»¥ç›´é€š"

    1. AMD RX400ã€RX500 ç³»åˆ—æµ‹è¯•æ— éœ€ romfile å‚æ•°ä¹Ÿå¯ä»¥ç›´é€š
    2. AMD RX5000ã€RX6000 ç³»åˆ—å¤§å¤šæ•°éœ€è¦ romfile å‚æ•°æ‰å¯ä»¥é¡ºåˆ©ç›´é€š

### é˜²æ­¢è™šæ‹Ÿæœºå´©æºƒ

æŸäº› Windows åº”ç”¨ç¨‹åºï¼ˆå¦‚ Geforce Experienceã€Passmark Performance Test å’Œ SiSoftware Sandra crashï¼‰å¯èƒ½ä¼šä½¿è™šæ‹Ÿæœºå´©æºƒã€‚ä»¥åŠä¸ºäº†é¿å…åœ¨PVE ä¸‹ macOS é»‘è‹¹æœå¼•å¯¼æœŸé—´å‡ºç°å¼•å¯¼å¾ªç¯æ­»æœºï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ï¼š

```bash
echo "options kvm ignore_msrs=1 report_ignored_msrs=0" > /etc/modprobe.d/kvm.conf && update-initramfs -k all -u && reboot
```

å…¶ä¸­ report_ignored_msrs=0 æ˜¯ä¸ºäº†é˜²æ­¢æ§åˆ¶å°åˆ·å±çœ‹åˆ°å¾ˆå¤šå¾ˆå¤šè­¦å‘Šæ¶ˆæ¯ç”¨çš„ï¼Œä¿®æ”¹å®Œæˆé‡å¯ PVE å³å¯ã€‚

